## 从输入URL到页面展示流程

* 首先，用户从浏览器进程里**输入请求信息**；
* 然后，网络进程**发起URL请求**；
* 服务器响应URL请求之后，浏览器进程就又要开始**准备渲染进程**了；
* 渲染进程准备好之后，需要先向渲染进程提交页面数据，我们称之为**提交文档**阶段；
* 渲染进程接受完文档信息之后，便开始**解析页面和加载子资源**，完成页面的渲染。

这其中，用户发出URL请求到页面开始解析的这个过程，就叫做导肮。

### 1.用户输入

* 当用户在地址栏中输入一个查询关键字时，地址栏会判断输入的关键字是**搜索内容**，还是**请求的URL**。
* 如果判断输入内容符合URL规则，比如输入的是time.geekbang.org，那么地址栏会根据规则，把这段内容加上协议，合成为完整的URL，如https://time.geekbang.org。

当浏览器刚开始加载一个地址之后，标签页上的图标便进入了一个加载状态。但此时图中页面显示的依然是之前打开的页面内容，并没立即替换为极客时间的页面。因为需要等待提交文档阶段，页面内容才会被替换。

### 2.URL请求过程

浏览器会通过进程间通信（IPC）把URL请求发送至网络进程，网络进程接收到URL请求后，会在这里发起真正的URL请求流程。

具体流程如下：

* 首先，网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到该资源，那么直接进入网络请求流程。这请求前的第一步是要进行DNS解析，以获取请求域名的服务器IP地址。如果请求协议是HTTPS，那么还需要建立TLS连接。

* 接下来就是利用IP地址和服务器建立TCP连接。连接建立之后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的Cookie等数据附加到请求头中，然后向服务器发送构建的请求信息。

* 服务器接收到请求信息后，会根据请求信息生成响应数据（包括响应行、响应头和响应体等信息），并发给网络流程。等网络进程接收了响应行和响应头之后，就开始解析响应头的内容了。

  * 重定向

    在接收到服务器返回的响应头后，网络进程开始解析响应头，如果发现返回的状态码是301或者302，那么说明服务器需要重定向到其他URL。这时网络进程会从响应头的Location字段里面读取重定向的地址，然后在发起新的HTTP或者HTTPS请求，一切又重头开始。

  * 响应数据类型处理

    在处理了跳转信息之后，我们继续导航流程的分析。URL请求的数据类型，有时候是一个下载类型，有时候是正常的HTML页面，那么浏览器是如何区分它们的呢？

    答案是Content-Type。**Content-Type是HTTP头中一个非常重要的字段，它告诉浏览器服务器返回的响应数据是什么类型**，然后浏览器会根据Content-Type的值来决定如何显示响应体的内容。

    需要注意的是，如果服务器配置Content-Type不正确，比如将text/html类型配置成application/octet-stream类型，那么浏览器很可能会曲解文件内容，比如会将一个本来是用来展示的页面，变成了一个下载文件。

    所以，不同的Content-Type的后续处理流程也截然不同。如果Content-Type字段的值被浏览器判断为**下载类型，那么该请求会被提交给浏览器的下载管理器，同时该URL请求的导航流程就此结束。**但如果是**HTML，那么浏览器则会继续进行导航流程**。由于Chrome的页面渲染时运行在渲染进程中的，所以接下来就需要准备渲染进程了。

### 3.准备渲染进程

默认情况下，Chrome会为每个页面分配一个渲染进程，也就是说，没打开一个新页面就会配套创建一个新的渲染进程。但是也有一些例外，在某些情况下，浏览器会让多个页面直接运行在同一个渲染进程中。

那什么情况下多个页面会同时运行在一个渲染进程中呢？

要解决这个问题，我们就需要先了解下什么是同一站点。具体地说，我们将‘同一站点’定为**根域名**加上**协议**，还包含了该根域名下所有的子域名和不同的端口。

Chrome的默认策略是，每个标签对应一个渲染进程。但**如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程**。

总结一下，打开一个新页面采用的**渲染进程策略**就是：

* 通常情况下，打开新的页面都会使用单独的渲染进程；
* 如果从A页面打开B页面，且A和B都属于同一站点的话，那么B页面复用A页面的渲染进程；如果是其他情况，浏览器进程则会为B创建一个新的渲染进程。

渲染进程准备好之后，还不能立即进入文档解析状态，因为此时的文档数据还在网络进程中，并没有提交给渲染进程，所以下一步就进入了提交文档阶段。

### 4.提交文档

首先明确，文档指的是URL请求的响应体数据。

* “提交文档”的消息是由浏览器进程发出的，渲染进程接收到“提交文档”的消息后，回合网络进程建立传输数据的“管道”。
* 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程。
* 浏览器进程在收到“确认提交”的消息后，会**更新浏览器界面状态**，包括安全状态、地址栏的URL、前进后退的历史状态，并更新Web页面。

### 5.渲染进程

一旦文档被提交，渲染进程便开始页面解析和子资源加载了。一旦页面生成完成，渲染进程会发送一个消息给浏览器进程，浏览器接收到消息后，会停止标签图标上的加载动画。

## 总结

* 服务器可以根据响应头来控制浏览器的行为，如跳转、网络数据类型判断。
* Chrome默认采用每个标签对应一个渲染进程，但是如果两个页面属于同一个站点，那这两个标签会使用同一个渲染进程。
* 浏览器的导航过程涵盖了从用户发起请求到提交文档给渲染进程的中间所有阶段。

导航流程很重要，它是网络加载流程和渲染流程之间的一座桥梁。